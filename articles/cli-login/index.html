<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Eleventy">
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
    <title>Ryan Martin | How to Implement Automatic CLI Login</title>
    <script src="/js/toc.js" defer=""></script>
  </head>
  <body>
    <header>
      <a href="/">ryanmartin.me</a>
      <nav>
            <a href="/articles/">Articles</a>
          
            <a href="/snippets/">Snippets</a>
          
            <a href="/tags/">Tags</a>
          
            <a href="/projects/">Projects</a>
          
            <a href="/">About</a>
          </nav>
    </header>
    <div id="top"></div>
    <main>
      
      
<article>
  <header>
    <h1>How to Implement Automatic CLI Login</h1>
    <p> <!-- wrap with p just to make the line height consistent -->
      <time>10 June 2024</time>
    </p>
    <ul class="tags"><li><a href="/tags/authentication">#authentication</a></li><li><a href="/tags/cryptography">#cryptography</a></li><li><a href="/tags/javascript">#javascript</a></li><li><a href="/tags/security">#security</a></li><li><a href="/tags/sveltekit">#sveltekit</a></li><li><a href="/tags/web-development">#web-development</a></li></ul>
  </header>
  <section id="content">
    <aside class="toc">
      <details><summary><h2>Table of Contents</h2></summary><ol><li><a href="#how-it-works">How it Works</a></li><li><a href="#project-setup">Project Setup</a></li><li><a href="#a-basic-authentication-system">A Basic Authentication System</a></li><li><a href="#the-cli-login-endpoints">The CLI Login Endpoints</a></li><li><a href="#writing-the-cli-tool">Writing the CLI Tool</a></li><li><a href="#security-considerations">Security Considerations</a></li><li><a href="#ecdh-key-exchange-%26-encryption">ECDH Key Exchange &amp; Encryption</a></li><li><a href="#securing-the-endpoints">Securing the Endpoints</a></li><li><a href="#what%E2%80%99s-next">What’s Next</a></li></ol></details></aside>
<p>I’ve recently had the chance to work on an “automatic CLI login” feature for a <a href="https://github.com/Argus-Labs/world-cli">CLI tool</a> at my day job. What I mean by automatic CLI login here is when a CLI tool automatically logs in a user, so it can perform actions on behalf of the user.</p>
<p>It usually works like this. When you type a command like <code>cli login</code> in your terminal, a login page will open in your web browser. After you log in, the page will show a message like “Your CLI is connected now”. When you go back to the terminal, it will say that it’s “connected” and you can now perform commands that require authentication.</p>
<p>The connection here is often in the form of an access token or an API key. This allows the CLI to stay logged in and perform authenticated requests to a remote server.</p>
<p>You’ve probably experienced this type of interaction before. Many modern CLI tools have some sort of command to allow you to log in from the command line. Examples include <a href="https://supabase.com/docs/reference/cli/introduction">Supabase CLI</a>, <a href="https://cli.github.com/">GitHub CLI</a>, <a href="https://graphite.dev/features/cli">Graphite CLI</a>, and Fly.io’s <a href="https://fly.io/docs/flyctl/"><code>flyctl</code></a>. It’s a UX pattern that I like, as it hides a lot of complexity from the user.</p>
<p>There are probably many different ways to implement this, each with different trade-offs. In this post, I’ll write about just one way of doing this, which is also the same approach used by Supabase and Fly.io.<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> It works for my particular use case and does not require refactoring my existing authentication logic.</p>
<h2 id="how-it-works" tabindex="-1"><a class="header-anchor" href="#how-it-works">How it Works</a></h2>
<p>At first glance, it looks like there is a two-way communication between the CLI tool and the browser. When you log in to the browser, you’ll receive an access token. Then the browser sends it to the CLI in some way?. Maybe the CLI starts up an HTTP server with an endpoint to receive the access token from the web page like the diagram below?</p>
<p><img loading="lazy" decoding="async" src="/img/8zjhL3f3r0-2146.webp" alt="Two-way communication scheme" width="2146" height="683"></p>
<p>This probably works, though I haven’t actually tested it yet. This isn’t the approach that I implemented, but it could be a good area for future experimentation.</p>
<p>How it works in Supabase CLI and <code>flyctl</code> is that it uses a “one-way” communication scheme instead of a two-way one.<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> Instead of the remote server sending the access token after the user has logged in, the CLI will keep polling for the access token in the background. At a high level, the flow should look like this diagram:</p>
<p><img loading="lazy" decoding="async" src="/img/stdV4wS9zs-2146.webp" alt="One-way communication scheme" width="2146" height="683"></p>
<p>The CLI will provide a session ID and ask the server to create a “CLI login session” when the user logs in successfully. An access token will be created for this specific session. Then, the CLI will request this access token from the server and store it for future requests.</p>
<p>Since this approach uses <a href="https://javascript.info/long-polling#regular-polling">regular HTTP polling</a>, it’s a potential source of <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DDOS attacks</a>. In a perfect world, a user needs to login to the CLI only once after they install the tool. The server is unlikely to get too many login requests at a time. In the real world, attackers can keep sending login requests to the server to slow or take it down. We can mitigate this by rate-limiting the endpoints and blocking malicious IP addresses, but it’s not a perfect defence.</p>
<p>This is a trade-off between security and code simplicity. HTTP polling is much simpler to implement than other solutions like <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API">WebSockets</a> or <a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events">SSE</a>. This might not work for you depending on your <a href="https://en.wikipedia.org/wiki/Threat_model">threat model</a>. But hey, if it works for Supabase, which has around 450,000 users,<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup> it’ll probably work for me too.</p>
<p>Now that we know how it works, let’s get into the code implementation. I’ll build a web server and a CLI tool for a fictional developer tools company, ACME Corp. The CLI tool will be called <code>acme</code>.</p>
<h2 id="project-setup" tabindex="-1"><a class="header-anchor" href="#project-setup">Project Setup</a></h2>
<p>I’ll use <a href="https://kit.svelte.dev">SvelteKit</a> for this project, but the concepts apply to any web framework. I’ll try to avoid using any svelte-specific features or terminologies so that you can apply this to any language or web framework you like.</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># create a new sveltekit project &amp; install dependencies</span>
<code style="user-select:none;color:var(--color-links)">$ </code><span class="token function">pnpm</span> create svelte@latest acme
<code style="user-select:none;color:var(--color-links)">$ </code><span class="token builtin class-name">cd</span> acme
<code style="user-select:none;color:var(--color-links)">$ </code><span class="token function">pnpm</span> <span class="token function">install</span></code></pre>
<p>I’ve heard good things about <a href="https://orm.drizzle.team/">Drizzle ORM</a>, so I’ll also use it as the ORM for this project. The database will be <a href="https://www.sqlite.org/">SQLite</a> using the <a href="https://github.com/WiseLibs/better-sqlite3/"><code>better-sqlite3</code></a> library. We’ll need to install these too.</p>
<pre class="language-bash"><code class="language-bash"><code style="user-select:none;color:var(--color-links)">$ </code><span class="token function">pnpm</span> <span class="token function">add</span> drizzle-orm better-sqlite3
<code style="user-select:none;color:var(--color-links)">$ </code><span class="token function">pnpm</span> <span class="token function">add</span> <span class="token parameter variable">-D</span> drizzle-kit</code></pre>
<p>Drizzle requires some setup steps before we can use it. First, we’ll create a Drizzle client:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/lib/db/db.js</span>
<span class="token keyword">import</span> Database <span class="token keyword">from</span> <span class="token string">'better-sqlite3'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> drizzle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'drizzle-orm/better-sqlite3'</span>

<span class="token keyword">const</span> sqlite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Database</span><span class="token punctuation">(</span><span class="token string">'data/database.db'</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">drizzle</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">)</span></code></pre>
<p>And define the database schema:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/lib/db/schema.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sqliteTable<span class="token punctuation">,</span> text <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'drizzle-orm/sqlite-core'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token function">sqliteTable</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">userId</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">primaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">$defaultFn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> sessions <span class="token operator">=</span> <span class="token function">sqliteTable</span><span class="token punctuation">(</span><span class="token string">'sessions'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">sessionId</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'session_id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">primaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">$defaultFn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">userId</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">references</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> users<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>The <code>users</code> table will store the user details, and the <code>sessions</code> table will store the authentication sessions. The app will use traditional <a href="https://roadmap.sh/guides/session-based-authentication">session-based authentication</a>.</p>
<p>Then, we need to update the config file:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// drizzle.config.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'drizzle-kit'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">dialect</span><span class="token operator">:</span> <span class="token string">'sqlite'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">schema</span><span class="token operator">:</span> <span class="token string">'./src/lib/db/schema.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dbCredentials</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'./data/database.db'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>To apply the changes to the database, run:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># create database directory</span>
<code style="user-select:none;color:var(--color-links)">$ </code><span class="token function">mkdir</span> data

<span class="token comment"># apply changes to database</span>
<code style="user-select:none;color:var(--color-links)">$ </code><span class="token function">pnpm</span> drizzle-kit push</code></pre>
<p>This will create the <code>data/database.db</code> SQLite database with our schema. You should only use <code>drizzle-kit push</code> for prototyping or local development. If you need database migrations, use <code>drizzle-kit generate</code> and <code>drizzle-kit migrate</code>. See the <a href="https://orm.drizzle.team/kit-docs/overview#prototyping-with-db-push">official documentation</a> for more info.</p>
<p>Finally, start the development server by running <code>pnpm dev</code>. The server should now be running at <code>http://localhost:5173</code>.</p>
<h2 id="a-basic-authentication-system" tabindex="-1"><a class="header-anchor" href="#a-basic-authentication-system">A Basic Authentication System</a></h2>
<p>As the focus of this post is on automatic CLI login, we won’t be doing anything fancy with user authentication. It’ll use a database-backed session-based authentication. I’ll also skip hashing the password and just store it in plaintext. You should never store passwords like this in a production system. Either use a third-party authentication service or follow the <a href="https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html">OWASP guide to password storage</a>.</p>
<p>First, let’s build a login page. For this app, the login page will serve as both the login and the signup page.<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></p>
<pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- src/routes/login/+page.svelte --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>log in<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>email<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">required</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>john.doe@email.com<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">required</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">></span></span>log in<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code></pre>
<p>The login form sends a POST request with the user’s email and password to this handler:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/routes/login/+page.server.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> db <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'$lib/db/db'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sessions<span class="token punctuation">,</span> users <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'$lib/db/schema'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fail<span class="token punctuation">,</span> redirect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@sveltejs/kit'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> eq <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'drizzle-orm'</span>

<span class="token comment">/** @type {import('./$types').Actions} */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> actions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> request<span class="token punctuation">,</span> cookies<span class="token punctuation">,</span> url <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> email <span class="token operator">=</span> form<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> password <span class="token operator">=</span> form<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email <span class="token operator">||</span> <span class="token operator">!</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'missing email or password'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> userData <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>email<span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> userData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> next <span class="token operator">=</span> url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token string">'/'</span>

    <span class="token comment">// register user if not exists &amp; create session</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newUserData <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token keyword">await</span> db
        <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>sessions<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">userId</span><span class="token operator">:</span> newUserData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>userId <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">returning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">,</span> session<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">303</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// else login</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>email <span class="token operator">===</span> user<span class="token punctuation">.</span>email <span class="token operator">&amp;&amp;</span> password <span class="token operator">===</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>sessions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">userId</span><span class="token operator">:</span> user<span class="token punctuation">.</span>userId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">,</span> session<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">303</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'invalid email or password'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre>
<p>The exported <code>actions</code> map is <a href="https://kit.svelte.dev/docs/form-actions">SvelteKit’s version of form action handlers</a>. You can just focus on the function in the <code>default</code> action.</p>
<p>If the user record doesn’t exist in the database, this function will create a new user and session in the database, set the required cookie in the response header, and redirect the user to the value in the <code>next</code> search param. If <code>next</code> is not specified, it will redirect to the home page instead. If the user is already registered, it will directly create the session, set the cookie, and redirect the user.</p>
<p>We’ll also add route protection to the home page. Unauthenticated requests to the home page will be redirected to the login page.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/routes/+page.server.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> db <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'$lib/db/db'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sessions<span class="token punctuation">,</span> users <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'$lib/db/schema'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@sveltejs/kit'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> eq <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'drizzle-orm'</span>

<span class="token comment">/** @type {import('./$types').PageServerLoad} */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> cookies <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sessionCookie <span class="token operator">=</span> cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sessionCookie<span class="token punctuation">)</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">'/login'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> sessionData <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>sessions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>sessions<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> sessionCookie<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> session <span class="token operator">=</span> sessionData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>session<span class="token punctuation">)</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">'/login'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> session<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> user<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The <code>load</code> function is a <a href="https://kit.svelte.dev/docs/load">function that runs before the page is rendered</a>. It’s similar to page/route controllers in other web frameworks like <a href="https://www.djangoproject.com/">Django</a> and <a href="https://rubyonrails.org/">Ruby on Rails</a>. If you open <code>http://localhost:5173</code> in your browser, you should be redirected to the login page.</p>
<p><img loading="lazy" decoding="async" src="/img/tAQxkDcEjc-800.webp" alt="Login page" width="800" height="485"></p>
<h2 id="the-cli-login-endpoints" tabindex="-1"><a class="header-anchor" href="#the-cli-login-endpoints">The CLI Login Endpoints</a></h2>
<p>Now let’s get to the main focus of this article. We’ll need to add new tables in our database schema to support this feature:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/lib/db/schema.js</span>
<span class="token comment">// ...</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> accessTokens <span class="token operator">=</span> <span class="token function">sqliteTable</span><span class="token punctuation">(</span><span class="token string">'access_tokens'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">tokenId</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'token_id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">primaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">$defaultFn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">userId</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">references</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> users<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> cliSessions <span class="token operator">=</span> <span class="token function">sqliteTable</span><span class="token punctuation">(</span><span class="token string">'cli_sessions'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">cliSessionId</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'cli_session_id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">primaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">$defaultFn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tokenId</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'token_id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">references</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> accessTokens<span class="token punctuation">.</span>tokenId<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>The <code>access_tokens</code> table will store the users’ access tokens, while the <code>cli_sessions</code> table will store the “login sessions” triggered by the CLI tool. When a user runs the command <code>acme login</code>, it will trigger a login session and an access token to be created in the server.</p>
<p>Run <code>pnpm drizzle-kit push</code> again to apply the changes to the database. If you encounter a SQLite read-only error in the SvelteKit, just restart the dev server.</p>
<p>We’ll also need to add new endpoints, <code>/cli/login</code> and <code>cli/login/:session</code>. Before we implement these endpoints, we’ll need a page to show the “Your CLI is now connected” message once the user has logged in.</p>
<pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- src/routes/cli/login/+page.svelte --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You're CLI is connected now. you can close this tab<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></code></pre>
<p>Now, here’s the code for the <code>/cli/login</code> route handler:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/routes/cli/login/+page.server.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> db <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'$lib/db/db'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> accessTokens<span class="token punctuation">,</span> cliSessions<span class="token punctuation">,</span> sessions<span class="token punctuation">,</span> users <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'$lib/db/schema'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> error<span class="token punctuation">,</span> redirect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@sveltejs/kit'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> eq <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'drizzle-orm'</span>

<span class="token comment">/** @type {import('./$types').PageServerLoad} */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> cookies<span class="token punctuation">,</span> url <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sessionCookie <span class="token operator">=</span> cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> next <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">+</span> url<span class="token punctuation">.</span>search<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sessionCookie<span class="token punctuation">)</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/login?next=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>next<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> sessionData <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>sessions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>sessions<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> sessionCookie<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> session <span class="token operator">=</span> sessionData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token comment">// if there is no valid session, redirect to login</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>session<span class="token punctuation">)</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/login?next=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>next<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

  <span class="token comment">// get user from session id</span>
  <span class="token keyword">const</span> userData <span class="token operator">=</span> <span class="token keyword">await</span> db
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">leftJoin</span><span class="token punctuation">(</span>sessions<span class="token punctuation">,</span> <span class="token function">eq</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> sessions<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>sessions<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> sessionCookie<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> userData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>users

  <span class="token keyword">const</span> params <span class="token operator">=</span> url<span class="token punctuation">.</span>searchParams
  <span class="token keyword">const</span> cliSessionId <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cliSessionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'missing search params'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> cliSessionData <span class="token operator">=</span> <span class="token keyword">await</span> db
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>cliSessions<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>cliSessions<span class="token punctuation">.</span>cliSessionId<span class="token punctuation">,</span> cliSessionId<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> cliSession <span class="token operator">=</span> cliSessionData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token comment">// create cli session &amp; access token if it doesn't exist</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cliSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>accessTokens<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">userId</span><span class="token operator">:</span> user<span class="token punctuation">.</span>userId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>cliSessions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">{</span> cliSessionId<span class="token punctuation">,</span> <span class="token literal-property property">tokenId</span><span class="token operator">:</span> token<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenId <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>This function first checks if the user is logged in using the cookie. The mechanism is the almost same as in the home page, with the only difference being that we’re setting the <code>next</code> search parameter to point back to this URL. This will redirect the user back to <code>/cli/login</code> after they have logged in.</p>
<p>If the user is already logged in,  a CLI session and an access token will be inserted into the database. Then, it’ll render the success message page from before. Note, in SvelteKit, after the <code>load</code> function in <code>+page.server.js</code> is called, the page in <code>+page.svelte</code> will be rendered. That’s why we don’t have to tell this function to render the page.</p>
<p>Next is the <code>/cli/login/:session</code> route handler:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/routes/cli/login/[session]/+server.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> db <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'$lib/db/db'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cliSessions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'$lib/db/schema'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@sveltejs/kit'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> eq <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'drizzle-orm'</span>

<span class="token comment">/** @type {import('./$types').RequestHandler} */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token constant">GET</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> params <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> session <span class="token punctuation">}</span> <span class="token operator">=</span> params

  <span class="token keyword">const</span> cliSessionData <span class="token operator">=</span> <span class="token keyword">await</span> db
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>cliSessions<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>cliSessions<span class="token punctuation">.</span>cliSessionId<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> cliSession <span class="token operator">=</span> cliSessionData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cliSession<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">token</span><span class="token operator">:</span> cliSession<span class="token punctuation">.</span>tokenId <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>This function checks if the session in the URL’s path param is a valid CLI session in the database. If it is, it’ll return the access token in the response body. This token will then be stored by the CLI tool and used in subsequent requests.</p>
<h2 id="writing-the-cli-tool" tabindex="-1"><a class="header-anchor" href="#writing-the-cli-tool">Writing the CLI Tool</a></h2>
<p>Our <code>acme</code> CLI tool will just be a single Node.js script. It’ll have only one command, <code>acme login</code>. As mentioned in the previous section, the CLI will request a login session and poll for the access token:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// acme.js</span>
<span class="token keyword">import</span> crypto <span class="token keyword">from</span> <span class="token string">'crypto'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'child_process'</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>_node<span class="token punctuation">,</span> _acme<span class="token punctuation">,</span> argv1<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv

<span class="token comment">// exit if program isn't run with the login command</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>argv1 <span class="token operator">||</span> argv1 <span class="token operator">!==</span> <span class="token string">'login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'usage: node acme.js login'</span><span class="token punctuation">)</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> host <span class="token operator">=</span> <span class="token string">'http://localhost:5173'</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// open the URL in the default browser</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/cli/login?session=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>session<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">xdg-open '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Here's your login link:\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// poll for the access token</span>
<span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/cli/login/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>session<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>ok <span class="token operator">?</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token keyword">return</span>

      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

      <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span></code></pre>
<p>The <code>acme</code> CLI will generate a random UUID for the session ID and include it as a search parameter in a URL to <code>/cli/login</code>. Then, it’ll call <code>exec</code>, which will run an OS process. In my case, it uses <code>xdg-open</code>, a Linux program that opens a file or URL with the user’s default application. If you’re using a Mac, replace this with <code>open</code>, and if you’re on Windows, replace it with <code>start</code>.</p>
<p>If you’re not already logged in, you will be redirected to the login page. Once you’ve logged in and seen the success message, the CLI should have already received the access token from the <code>/cli/login/:session</code> endpoint. If you run this script, you should get something like this:</p>
<p><img loading="lazy" decoding="async" src="/img/zkfVaed1b4-800.webp" alt="The CLI login flow" width="800" height="485"></p>
<p>Nice! We now have a working automatic CLI login system. Note, I cleared the cookies in the video above so that I can log in again. If you didn’t do this, you’ll go straight to the success message as you’re already logged in. I also created a shell alias to make the script look like a “proper” CLI tool:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># create the alias</span>
<code style="user-select:none;color:var(--color-links)">$ </code><span class="token builtin class-name">alias</span> <span class="token assign-left variable">acme</span><span class="token operator">=</span><span class="token string">'node acme.js'</span>

<span class="token comment"># then you can run</span>
<code style="user-select:none;color:var(--color-links)">$ </code>acme login</code></pre>
<h2 id="security-considerations" tabindex="-1"><a class="header-anchor" href="#security-considerations">Security Considerations</a></h2>
<p>I’ve mentioned DDOS attacks before as one of the vulnerabilities of this login flow. I’ll mention a few more and also explain the ways to mitigate it. This isn’t a comprehensive list of security vulnerabilities though. You might need to conduct security tests or assessments depending on your threat model.</p>
<p>One type of attack we’re vulnerable to is the <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle attack</a>. A man-in-the-middle attack can happen when we try to log in over an insecure connection. An attacker can listen to your network traffic and steal your access tokens. Thankfully this kind of attack is easy to mitigate by using a secure connection like HTTPS. HTTPS encrypts your network traffic, preventing a third party from reading your network activity.</p>
<p>Another kind of attack is a <a href="https://en.wikipedia.org/wiki/Brute-force_attack">brute force attack</a>. Since the endpoints to poll for the access tokens don’t require authentication, attackers can brute force UUID values until they get an access token. This can be mitigated by expiring the CLI sessions and applying the same strategies as with DDOS attacks.</p>
<p>Both of these attacks have one thing in common. If an attacker gets a hold of your access token, you’re hacked. We can increase the security of our app by encrypting the access tokens. This way, even if attackers obtain an encrypted access token, they won’t be able to decrypt it.</p>
<p>Encrypting the tokens presents some challenges. How do we ensure that only the CLI can decrypt the token? What encryption scheme should be used? What if an attacker obtained the decryption key?</p>
<h2 id="ecdh-key-exchange-%26-encryption" tabindex="-1"><a class="header-anchor" href="#ecdh-key-exchange-%26-encryption">ECDH Key Exchange &amp; Encryption</a></h2>
<p>One possible solution is to use <a href="https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman">ECDH key exchange</a>. ECDH (Elliptic Curve Diffie–Hellman Key Exchange) is a method that allows two parties to establish a shared secret over an insecure channel. ECDH is based on <a href="https://en.wikipedia.org/wiki/Elliptic-curve_cryptography">ECC</a> (elliptic curve cryptography), a modern family of public-key cryptography and is considered the modern successor of RSA.<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup></p>
<p>Here’s a high-level explanation of how ECDH works:<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup></p>
<ol>
<li>Alice generates a random ECC key pair: <strong>alicePriv</strong> &amp; <strong>alicePub</strong>.</li>
<li>Bob generates a random ECC key pair: <strong>bobPriv</strong> &amp; <strong>bobPub</strong>.</li>
<li>Alice and Bob exchange their public keys over an insecure channel like the Internet.</li>
<li>Alice calculates the <strong>secret</strong> = <strong>alicePriv</strong> * <strong>bobPub</strong></li>
<li>Bob calculates the <strong>secret</strong> = <strong>bobPriv</strong> * <strong>alicePub</strong></li>
<li>Alice and Bob now have the same shared <strong>secret</strong></li>
</ol>
<p>This works because, in the ECDH algorithm, <strong>alicePriv</strong> * <strong>bobPub</strong> is equal to <strong>bobPriv</strong> * <strong>alicePub</strong>.</p>
<p>Unlike RSA, ECC doesn’t directly provide a way to do asymmetric encryption. Instead, we have to devise our own hybrid encryption scheme using a combination of ECDH and symmetric encryption. We can use any symmetric encryption algorithms we want like <a href="https://cryptobook.nakov.com/symmetric-key-ciphers/aes-cipher-concepts">AES</a> or <a href="https://en.wikipedia.org/wiki/ChaCha20-Poly1305">ChaCha20-Poly1305</a>. Here’s how the hybrid encryption scheme works:</p>
<ol>
<li>Alice generates a random ECC key pair: <strong>alicePriv</strong> &amp; <strong>alicePub</strong>.</li>
<li>Bob generates a random ECC key pair: <strong>bobPriv</strong> &amp; <strong>bobPub</strong>.</li>
<li>Alice and Bob exchange their public keys over the internet.</li>
<li>Alice calculates the <strong>secret</strong> = <strong>alicePriv</strong> * <strong>bobPub</strong></li>
<li>Alice encrypts a <strong>plaintext</strong> using the <strong>secret</strong> as the symmetric encryption key.</li>
<li>Alice sends the <strong>ciphertext</strong> to Bob over the Internet.</li>
<li>Bob calculates the <strong>secret</strong> = <strong>bobPriv</strong> * <strong>alicePub</strong></li>
<li>Bob decrypts the <strong>ciphertext</strong> using the <strong>secret</strong> as the decryption key.</li>
</ol>
<p>While the underlying maths might be complex, the encryption scheme is straightforward. Now, let’s implement this in our code. We’ll use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API">WebCrypto API</a> as the cryptography library.</p>
<h2 id="securing-the-endpoints" tabindex="-1"><a class="header-anchor" href="#securing-the-endpoints">Securing the Endpoints</a></h2>
<p>First, we need to update our <code>cli_sessions</code> table definition to store the CLI’s public key.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/lib/db/schema.js</span>
<span class="token comment">// ...</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> cliSessions <span class="token operator">=</span> <span class="token function">sqliteTable</span><span class="token punctuation">(</span><span class="token string">'cli_sessions'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">cliSessionId</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'cli_session_id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">primaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">$defaultFn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tokenId</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'token_id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">references</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> accessTokens<span class="token punctuation">.</span>tokenId<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pubKey</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'pub_key'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// &lt;-- new column</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Run <code>pnpm drizzle-kit push</code> again. This time, you should be prompted to delete some records. As we’re just testing, we can always wipe the DB clean to start over.</p>
<p>Next, we’ll update the <code>/cli/login</code> endpoint to get the public key from the search parameter and insert it into the database:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/routes/cli/login/+page.server.js</span>
<span class="token comment">// ...</span>

<span class="token comment">/** @type {import('./$types').PageServerLoad} */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> cookies<span class="token punctuation">,</span> url <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">const</span> params <span class="token operator">=</span> url<span class="token punctuation">.</span>searchParams
  <span class="token keyword">const</span> cliSessionId <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> pubKey <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'pub_key'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cliSessionId <span class="token operator">||</span> <span class="token operator">!</span>pubKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'missing search params'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>accessTokens<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">userId</span><span class="token operator">:</span> user<span class="token punctuation">.</span>userId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>cliSessions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">{</span> cliSessionId<span class="token punctuation">,</span> pubKey<span class="token punctuation">,</span> <span class="token literal-property property">tokenId</span><span class="token operator">:</span> token<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tokenId <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>As for the <code>/cli/login/:session</code> endpoint, instead of returning the access token directly, we’ll need to encrypt it first. We’ll refactor this endpoint’s handler function to implement the encryption:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/routes/cli/login/[session]/+server.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> bytesToHex<span class="token punctuation">,</span> hexToBytes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'$lib/utils'</span>
<span class="token comment">// ...</span>

<span class="token comment">/** @type {import('./$types').RequestHandler} */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token constant">GET</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> params <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cliSession<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>

  <span class="token comment">// generate ECC key pair</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> privateKey<span class="token punctuation">,</span> publicKey <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ECDH'</span><span class="token punctuation">,</span> <span class="token literal-property property">namedCurve</span><span class="token operator">:</span> <span class="token string">'P-256'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'deriveKey'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> publicKeyBuffer <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">exportKey</span><span class="token punctuation">(</span><span class="token string">'raw'</span><span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span>
  <span class="token keyword">const</span> remotePublicKey <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">importKey</span><span class="token punctuation">(</span>
    <span class="token string">'raw'</span><span class="token punctuation">,</span>
    <span class="token function">hexToBytes</span><span class="token punctuation">(</span>cliSession<span class="token punctuation">.</span>pubKey<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ECDH'</span><span class="token punctuation">,</span> <span class="token literal-property property">namedCurve</span><span class="token operator">:</span> <span class="token string">'P-256'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// encrypt the access token using aes-gcm-256 and the secret key</span>
  <span class="token keyword">const</span> enc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">deriveKey</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ECDH'</span><span class="token punctuation">,</span> <span class="token keyword">public</span><span class="token operator">:</span> remotePublicKey <span class="token punctuation">}</span><span class="token punctuation">,</span>
    privateKey<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'AES-GCM'</span><span class="token punctuation">,</span> <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">256</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'encrypt'</span><span class="token punctuation">,</span> <span class="token string">'decrypt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// iv in aes-gcm-256 must be 12 bytes long</span>
  <span class="token keyword">const</span> iv <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> encrypted <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'AES-GCM'</span><span class="token punctuation">,</span> <span class="token literal-property property">iv</span><span class="token operator">:</span> iv <span class="token punctuation">}</span><span class="token punctuation">,</span>
    secret<span class="token punctuation">,</span>
    enc<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>cliSession<span class="token punctuation">.</span>tokenId<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token function">bytesToHex</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">pubKey</span><span class="token operator">:</span> <span class="token function">bytesToHex</span><span class="token punctuation">(</span>publicKeyBuffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">iv</span><span class="token operator">:</span> <span class="token function">bytesToHex</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>Now, this function will generate a random ECC key pair to calculate the secret using the public key provided by the CLI. I’m using the <a href="https://csrc.nist.gov/csrc/media/events/workshop-on-elliptic-curve-cryptography-standards/documents/papers/session6-adalier-mehmet.pdf">NIST P-256</a> curve as the basis of the ECC key pair as the <a href="https://developer.mozilla.org/en-US/docs/Web/API/EcKeyGenParams">WebCrypto API only supports NIST curves</a> at the moment.<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup></p>
<p>This secret is then used as the key for the symmetric encryption algorithm. I use AES-GCM here because it’s also directly supported in WebCrypto. The secret here is 32 bytes long, which means we’ll use a 256-bit key. AES-GCM encryption with a 256-bit key requires a nonce value (<code>iv</code>) of 12 bytes, which we also need to send to the user along with the server’s public key.</p>
<p>The private and public keys are byte arrays here, so we also need some helper functions here to decode byte arrays from/to hex strings:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// src/lib/utils.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">bytesToHex</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">bytes</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">hexToBytes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">hex</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hexBytes <span class="token operator">=</span> hex<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.{1,2}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">return</span> Uint8Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>hexBytes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">byte</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">parseInt</span><span class="token punctuation">(</span>byte<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>Finally, we have to update the CLI code to decrypt the access token:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// acme.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> bytesToHex<span class="token punctuation">,</span> hexToBytes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./src/lib/utils.js'</span>
<span class="token comment">// ...</span>

<span class="token keyword">const</span> <span class="token function-variable function">randomKeyPair</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ECDH'</span><span class="token punctuation">,</span> <span class="token literal-property property">namedCurve</span><span class="token operator">:</span> <span class="token string">'P-256'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'deriveKey'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">decrypt</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">privateKey<span class="token punctuation">,</span> publicKey<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> encrypted</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> remotePublicKey <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">importKey</span><span class="token punctuation">(</span>
    <span class="token string">'raw'</span><span class="token punctuation">,</span>
    publicKey<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ECDH'</span><span class="token punctuation">,</span> <span class="token literal-property property">namedCurve</span><span class="token operator">:</span> <span class="token string">'P-256'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">deriveKey</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ECDH'</span><span class="token punctuation">,</span> <span class="token keyword">public</span><span class="token operator">:</span> remotePublicKey <span class="token punctuation">}</span><span class="token punctuation">,</span>
    privateKey<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'AES-GCM'</span><span class="token punctuation">,</span> <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">256</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'encrypt'</span><span class="token punctuation">,</span> <span class="token string">'decrypt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> decrypted <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'AES-GCM'</span><span class="token punctuation">,</span> <span class="token literal-property property">iv</span><span class="token operator">:</span> iv <span class="token punctuation">}</span><span class="token punctuation">,</span> secret<span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span>
  <span class="token keyword">const</span> dec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> dec<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>decrypted<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> host <span class="token operator">=</span> <span class="token string">'http://localhost:5173'</span>
  <span class="token keyword">const</span> session <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> privateKey<span class="token punctuation">,</span> publicKey <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">randomKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> publicKeyBuffer <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">exportKey</span><span class="token punctuation">(</span><span class="token string">'raw'</span><span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span>

  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/cli/login?session=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>session<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;pub_key=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bytesToHex</span><span class="token punctuation">(</span>publicKeyBuffer<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">xdg-open '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Here's your login link:\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/cli/login/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>session<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>ok <span class="token operator">?</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token keyword">return</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span> token<span class="token punctuation">,</span> pubKey<span class="token punctuation">,</span> iv <span class="token punctuation">}</span> <span class="token operator">=</span> data

        <span class="token function">decrypt</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">,</span> <span class="token function">hexToBytes</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">hexToBytes</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">hexToBytes</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter">accessToken</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Your access token:'</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>_node<span class="token punctuation">,</span> _acme<span class="token punctuation">,</span> argv1<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>argv1 <span class="token operator">||</span> argv1 <span class="token operator">!==</span> <span class="token string">'login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'usage: node acme.js login'</span><span class="token punctuation">)</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>The <code>decrypt</code> function follows the same steps as the encryption process, just reversed. And that’s it. When we run the script now, we should see that the login flow still works the same:</p>
<p><img loading="lazy" decoding="async" src="/img/V6YTFcZrKa-800.webp" alt="Checking the new CLI login flow" width="800" height="485"></p>
<p>You can also see the decrypted token is the same as the token in the database.</p>
<h2 id="what%E2%80%99s-next" tabindex="-1"><a class="header-anchor" href="#what%E2%80%99s-next">What’s Next</a></h2>
<p>You can find the code for this project <a href="https://github.com/rmrt1n/rmrt1n.github.io/tree/main/code/cli-login">on GitHub</a>. I’ve only covered the minimum required to implement automatic CLI login with encryption. There’s always room for improvement. E.g., you can implement additional features such as CLI session expiry, rate-limiting, token expiry, and more. Good luck!</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>I learned about how this works mostly by digging into the <a href="https://github.com/supabase/cli">Supabase CLI code</a>, so I’m biased toward this approach. You can also see <a href="https://supabase.com/blog/automatic-cli-login">Supabase’s blog post about this</a> and <a href="https://fly.io/laravel-bytes/making-the-cli-and-browser-talk/">Fly’s guide on implementing this in Laravel</a>. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>I call it one-way communication here, but what I meant is that only one participant, this being the CLI, is making the requests. Contrast this to the other approach where both participants are sending requests to each other. <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>450,000 is the number of registered developers on <a href="https://supabase.com/company">their website</a>. It’s a vanity metric, but it’s still an impressive number. <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p>I made this choice just to keep the code as small as possible. You shouldn’t do this in a real app unless you have a really specific reason. This UX is unfamiliar and can confuse users. <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p>Check out <a href="https://cryptobook.nakov.com/asymmetric-key-ciphers/ecdh-key-exchange">the section on ECDH</a> from the <a href="https://cryptobook.nakov.com/">Practical Cryptography for Developers</a> book for more details on how the algorithm works. It’s also a great resource for learning about cryptography in general without going too deep into the maths. <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p>This post assumes you know about RSA and basic cryptography concepts. It’s fine if you don’t, but the concepts explained will make more sense if you do. Here’s a good <a href="https://www.comparitech.com/blog/information-security/cryptography-guide/">introduction to cryptography article</a> that explains the basic concepts as well as resources if you want to learn further. <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p>If I’m using a third-party library like <a href="https://github.com/paulmillr/noble-curves">@noble/curves</a>, I’ll use <a href="https://en.wikipedia.org/wiki/Curve25519">X25519</a> for ECDH. I’m not an expert in ECC, and most of my algorithm/curve choices are based on <a href="https://soatok.blog/2022/05/19/guidance-for-choosing-an-elliptic-curve-signature-algorithm-in-2022/">this blog post on choosing an elliptic curve signature algorithm</a>. Although it’s about digital signatures (<a href="https://cryptobook.nakov.com/digital-signatures/ecdsa-sign-verify-messages">ECDSA</a>), I still find it helpful for ECDH. <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

  </section>
</article>

    </main>
    <footer>
      <div>
        <small>&copy; 2024-2025 Ryan Martin - CC BY-NC-SA 4.0</small>
        <small><a href="#top">Back to top ⤴</a></small>
      </div>
      <small>
        <a href="/feed.xml">
          Subscribe via RSS
          <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="16" height="16" style="height: 1.2em; width: 1.2em; vertical-align: text-bottom" viewBox="0 0 256 256">
            <circle cx="68" cy="189" r="24" fill="currentColor"></circle>
            <path d="M160 213h-34a82 82 0 0 0 -82 -82v-34a116 116 0 0 1 116 116z" fill="currentColor"></path>
            <path d="M184 213A140 140 0 0 0 44 73 V 38a175 175 0 0 1 175 175z" fill="currentColor"></path>
          </svg>
          </a>
      </small>
      <small><a href="/colophon/">Colophon</a></small>
    </footer>
  </body>
</html>

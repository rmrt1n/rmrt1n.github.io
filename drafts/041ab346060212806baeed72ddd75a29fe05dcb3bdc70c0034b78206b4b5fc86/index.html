<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <title>Deploying a Clojure App to Fly.io</title>
  </head>
  <body>
    <header>
      <a href="/">Ryan Martin</a>
      <nav>
            <a href="/articles/">Articles</a>
          
            <a href="/snippets/">Snippets</a>
          
            <a href="/tags/">Tags</a>
          
            <a href="/projects/">Projects</a>
          
            <a href="/">About</a>
          </nav>
    </header>
    <main>
      
<article>
  <h1>Deploying a Clojure App to Fly.io</h1>
  <time>last updated: 2024-09-10</time>
  <p>I’ve been building a Clojure web application and reached the point where I needed to deploy it to a live server. The app itself is nowhere near usable yet but I wanted to make sure that it would work in a production environment. I needed a way to deploy the app without requiring much work on my end.</p>
<p>After some consideration, I went with <a href="https://fly.io">Fly.io</a>. It’s a service that allows you to deploy applications packaged as docker images on lightweight virtual machines.<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> In my experience it’s easy to use and quick to setup. One downside of Fly is that it doesn’t have a free tier, but since I don’t plan on leaving the app deployed, it barely costs me anything.</p>
<p>I found some helpful tips while trying to deploy my app, so I thought I’d share them here.</p>
<p>Personally, I like technical articles that cover a project from start to finish, so this post will also cover the development (of a demo app) in addition to the deployment process. If you just want to read about the deployment, feel free to [[#Packaging the Application |skip ahead]]. Note, this is not a “from zero” tutorial though. I’ll assume you have some familiarity with Clojure<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> and some of its libraries.</p>
<h2 id="project-setup" tabindex="-1"><a class="header-anchor" href="#project-setup">Project Setup</a></h2>
<p>In this post, we’ll be building a barebones bookmarks manager for the demo app. Users can log in using <a href="https://roadmap.sh/guides/http-basic-authentication">basic authentication</a>, view all bookmarks, and create a new bookmark. It’ll be a traditional multi-page web app and the data will be stored in a <a href="https://sqlite.org">SQLite</a> database.</p>
<p>Here’s an overview of the project’s starting directory structure:</p>
<pre class="language-plaintext"><code class="language-plaintext">.
├── dev
│   └── user.clj
├── resources
│   └── config.edn
├── src
│   └── acme
│       └── main.clj
└── deps.edn</code></pre>
<p>Here are the libraries we’re going to use. If you have some Clojure experience or have used <a href="https://kit-clj.github.io/">Kit</a>, you’re probably already familiar with all the libraries listed below.<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; deps.edn</span>
<span class="token punctuation">{</span><span class="token symbol">:paths</span> <span class="token punctuation">[</span><span class="token string">"src"</span> <span class="token string">"resources"</span><span class="token punctuation">]</span>
 <span class="token symbol">:deps</span> <span class="token punctuation">{</span>org.clojure/clojure               <span class="token punctuation">{</span><span class="token symbol">:mvn/version</span> <span class="token string">"1.12.0"</span><span class="token punctuation">}</span>
        aero/aero                         <span class="token punctuation">{</span><span class="token symbol">:mvn/version</span> <span class="token string">"1.1.6"</span><span class="token punctuation">}</span>
        integrant/integrant               <span class="token punctuation">{</span><span class="token symbol">:mvn/version</span> <span class="token string">"0.11.0"</span><span class="token punctuation">}</span>
        ring/ring-jetty-adapter           <span class="token punctuation">{</span><span class="token symbol">:mvn/version</span> <span class="token string">"1.12.2"</span><span class="token punctuation">}</span>
        metosin/reitit-ring               <span class="token punctuation">{</span><span class="token symbol">:mvn/version</span> <span class="token string">"0.7.2"</span><span class="token punctuation">}</span>
        com.github.seancorfield/next.jdbc <span class="token punctuation">{</span><span class="token symbol">:mvn/version</span> <span class="token string">"1.3.939"</span><span class="token punctuation">}</span>
        org.xerial/sqlite-jdbc            <span class="token punctuation">{</span><span class="token symbol">:mvn/version</span> <span class="token string">"3.46.1.0"</span><span class="token punctuation">}</span>
        hiccup/hiccup                     <span class="token punctuation">{</span><span class="token symbol">:mvn/version</span> <span class="token string">"2.0.0-RC3"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
 <span class="token symbol">:aliases</span>
 <span class="token punctuation">{</span><span class="token symbol">:dev</span> <span class="token punctuation">{</span><span class="token symbol">:extra-paths</span> <span class="token punctuation">[</span><span class="token string">"dev"</span><span class="token punctuation">]</span>
        <span class="token symbol">:extra-deps</span>  <span class="token punctuation">{</span>nrepl/nrepl    <span class="token punctuation">{</span><span class="token symbol">:mvn/version</span> <span class="token string">"1.3.0"</span><span class="token punctuation">}</span>
                     integrant/repl <span class="token punctuation">{</span><span class="token symbol">:mvn/version</span> <span class="token string">"0.3.3"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token symbol">:main-opts</span>   <span class="token punctuation">[</span><span class="token string">"-m"</span> <span class="token string">"nrepl.cmdline"</span> <span class="token string">"--interactive"</span> <span class="token string">"--color"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>
<p>I use <a href="">Aero</a> and <a href="">Integrant</a> for my system configuration and management (more on this in the next section), <a href="">Ring</a> with the <a href="">Jetty adapter</a> for the web server, <a href="">Reitit</a> for routing, <a href="">Next.jdbc</a> for database interaction, and <a href="">Hiccup</a> for rendering HTML. In my experience this this is a popular “library combination” for building web apps in Clojure.</p>
<p>If you haven’t already, start a REPL and connect to it from your editor. The <code>user</code> namespace in <code>dev/user.clj</code> contains helper functions from <a href="">Integrant-repl</a> to start/stop/restart the Integrant system.</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; dev/user.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> user
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token punctuation">[</span>acme.main <span class="token symbol">:as</span> main<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>clojure.tools.namespace.repl <span class="token symbol">:as</span> repl<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>integrant.core <span class="token symbol">:as</span> ig<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>integrant.repl <span class="token symbol">:refer</span> <span class="token punctuation">[</span>set-prep! go halt reset reset-all<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">set-prep!</span>
 <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
   <span class="token punctuation">(</span><span class="token function">ig/expand</span> <span class="token punctuation">(</span><span class="token function">main/read-config</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">repl/set-refresh-dirs</span> <span class="token string">"src"</span> <span class="token string">"resources"</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">comment</span>
  <span class="token punctuation">(</span><span class="token function">go</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">halt</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">reset</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">reset-all</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h2 id="systems-and-configuration" tabindex="-1"><a class="header-anchor" href="#systems-and-configuration">Systems and Configuration</a></h2>
<p>If you’re not familiar with Integrant, <a href="">Component</a>, or similar dependency injection libraries, I’d suggest reading <a href="">this article explaining why they’re needed</a>. Like most Clojure apps that use Aero and Integrant, my system configuration lives in a <code>.edn</code> file. I usually name mine as <code>resources/config.edn</code> file. Here’s what it looks like:</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; resources/config.edn</span>
<span class="token punctuation">{</span><span class="token symbol">:server</span>
 <span class="token punctuation">{</span><span class="token symbol">:port</span> <span class="token operator">#</span>long <span class="token operator">#</span>or <span class="token punctuation">[</span><span class="token operator">#</span>env PORT <span class="token number">8080</span><span class="token punctuation">]</span>
  <span class="token symbol">:host</span> <span class="token operator">#</span>or <span class="token punctuation">[</span><span class="token operator">#</span>env HOST <span class="token string">"0.0.0.0"</span><span class="token punctuation">]</span>
  <span class="token symbol">:auth</span> <span class="token punctuation">{</span><span class="token symbol">:username</span> <span class="token operator">#</span>or <span class="token punctuation">[</span><span class="token operator">#</span>env AUTH_USER <span class="token string">"john.doe@email.com"</span><span class="token punctuation">]</span>
         <span class="token symbol">:password</span> <span class="token operator">#</span>or <span class="token punctuation">[</span><span class="token operator">#</span>env AUTH_PASSWORD <span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

 <span class="token symbol">:database</span>
 <span class="token punctuation">{</span><span class="token symbol">:dbtype</span> <span class="token string">"sqlite"</span>
  <span class="token symbol">:dbname</span> <span class="token operator">#</span>or <span class="token punctuation">[</span><span class="token operator">#</span>env DB_DATABASE <span class="token string">"database.db"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>
<p>In production, most of these values will be set using environment variables. During local development, the app will use the hard coded default values. We don’t have any sensitive values in our config (e.g., API keys), so it’s fine to commit this file to version control. If there are such values, I’d suggest putting them in another file that’s not tracked by version control and including them to the config file using Aero’s <code>#include</code> reader tag.</p>
<p>This config file is then “expanded” into the Integrant system map using the <code>expand-key</code> method:</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/main.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.main
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token punctuation">[</span>aero.core <span class="token symbol">:as</span> aero<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>clojure.java.io <span class="token symbol">:as</span> io<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>integrant.core <span class="token symbol">:as</span> ig<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> read-config
  <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">{</span><span class="token symbol">:system/config</span> <span class="token punctuation">(</span><span class="token function">aero/read-config</span> <span class="token punctuation">(</span><span class="token function">io/resource</span> <span class="token string">"config.edn"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defmethod</span> ig/expand-key <span class="token symbol">:system/config</span>
  <span class="token punctuation">[</span>_ opts<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>server database<span class="token punctuation">]</span><span class="token punctuation">}</span> opts<span class="token punctuation">]</span>
    <span class="token punctuation">{</span><span class="token symbol">:server/jetty</span> <span class="token punctuation">(</span><span class="token keyword">assoc</span> server <span class="token symbol">:handler</span> <span class="token punctuation">(</span><span class="token function">ig/ref</span> <span class="token symbol">:handler/ring</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token symbol">:handler/ring</span> <span class="token punctuation">{</span><span class="token symbol">:database</span> <span class="token punctuation">(</span><span class="token function">ig/ref</span> <span class="token symbol">:database/sql</span><span class="token punctuation">)</span>
                    <span class="token symbol">:auth</span>     <span class="token punctuation">(</span><span class="token symbol">:auth</span> server<span class="token punctuation">)</span><span class="token punctuation">}</span>
     <span class="token symbol">:database/sql</span> database<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>The system map is created in code instead of being in the configuration file. This makes refactoring your system simpler as you only need to change this method while leaving the config file (mostly) untouched.<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></p>
<p>My current approach to integrant + aero config files is mostly inspired by the blog post <a href="https://robjohnson.dev/posts/aero-and-integrant/">“Rethinking Config with Aero &amp; Integrant”</a> and Laravel’s configuration. The config file follows a similar structure to Laravel’s config files and contains the app configurations without describing the structure of the system. Previously I had a key for each Integrant component, which lead to the config file being littered with <code>#ig/ref</code> and more difficult to refactor.</p>
<p>Next, we’ll implement the <code>init-key</code> and <code>halt-key!</code> methods for each of the components:</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/main.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.main
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token comment">;; ...</span>
   <span class="token punctuation">[</span>acme.handler <span class="token symbol">:as</span> handler<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>acme.util <span class="token symbol">:as</span> util<span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">[</span>next.jdbc <span class="token symbol">:as</span> jdbc<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>ring.adapter.jetty <span class="token symbol">:as</span> jetty<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; ...</span>

<span class="token punctuation">(</span><span class="token keyword">defmethod</span> ig/init-key <span class="token symbol">:server/jetty</span>
  <span class="token punctuation">[</span>_ opts<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>handler port<span class="token punctuation">]</span><span class="token punctuation">}</span> opts
        jetty-opts <span class="token punctuation">(</span><span class="token keyword">-></span> opts <span class="token punctuation">(</span><span class="token keyword">dissoc</span> <span class="token symbol">:handler</span> <span class="token symbol">:auth</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">assoc</span> <span class="token symbol">:join?</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        server     <span class="token punctuation">(</span><span class="token function">jetty/run-jetty</span> handler jetty-opts<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">"Server started on port "</span> port<span class="token punctuation">)</span>
    server<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defmethod</span> ig/halt-key! <span class="token symbol">:server/jetty</span>
  <span class="token punctuation">[</span>_ server<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">.stop</span> server<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defmethod</span> ig/init-key <span class="token symbol">:handler/ring</span>
  <span class="token punctuation">[</span>_ opts<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">handler/handler</span> opts<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defmethod</span> ig/init-key <span class="token symbol">:database/sql</span>
  <span class="token punctuation">[</span>_ opts<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>datasource <span class="token punctuation">(</span><span class="token function">jdbc/get-datasource</span> opts<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token function">util/setup-db</span> datasource<span class="token punctuation">)</span>
    datasource<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>The <code>setup-db</code> function creates the required tables in the database if they don’t exist yet. This works fine for database migrations in small projects like this demo app, but for larger projects, consider using libraries such as <a href="">Migratus</a>(my preferred migration library), <a href="">automigrate</a>, or [ragtime].</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/util.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.util 
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token punctuation">[</span>next.jdbc <span class="token symbol">:as</span> jdbc<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> setup-db
  <span class="token punctuation">[</span>db<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">jdbc/execute-one!</span>
   db
   <span class="token punctuation">[</span><span class="token string">"create table if not exists bookmarks (
       bookmark_id text primary key not null,
       url text not null,
       created_at datetime default (unixepoch()) not null
     )"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>For the server handler, let’s start with a simple function that returns a “hi world” string.</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/handler.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.handler
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token punctuation">[</span>ring.util.response <span class="token symbol">:as</span> res<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> handler
  <span class="token punctuation">[</span>_opts<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span>req<span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token function">res/response</span> <span class="token string">"hi world"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>Now all the components are implemented. We can check if the system is working properly by evaluating <code>(reset)</code> in the <code>user</code> namespace. This will reload your files and restart the system. You should see this message printed in your REPL:</p>
<pre class="language-plaintext"><code class="language-plaintext">:reloading (acme.util acme.handler acme.main)
Server started on port  8080
:resumed</code></pre>
<p>If we send a request to <code>localhost:8080/</code>, we should get “hi world” as the response:</p>
<pre class="language-bash"><code class="language-bash"><code style="user-select:none;color:var(--color-links)">$ </code><span class="token function">curl</span> localhost:8080/
hi world</code></pre>
<p>Nice! The system is working correctly. In the next section, we’ll implement routing and our business logic handlers.</p>
<h2 id="routing%2C-middlewares%2C-and-route-handlers" tabindex="-1"><a class="header-anchor" href="#routing%2C-middlewares%2C-and-route-handlers">Routing, Middlewares, and Route Handlers</a></h2>
<p>First, let’s setup a ring handler and router using Reitit. We only have one route, the index <code>/</code> route that’ll handle both GET and POST requests.</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/handler.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.handler
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token punctuation">[</span>reitit.ring <span class="token symbol">:as</span> ring<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">def</span> routes
  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"/"</span> <span class="token punctuation">{</span><span class="token symbol">:get</span>  index-page
         <span class="token symbol">:post</span> index-action<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> handler
  <span class="token punctuation">[</span>opts<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">ring/ring-handler</span>
   <span class="token punctuation">(</span><span class="token function">ring/router</span> routes<span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token function">ring/routes</span>
    <span class="token punctuation">(</span><span class="token function">ring/redirect-trailing-slash-handler</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">ring/create-resource-handler</span> <span class="token punctuation">{</span><span class="token symbol">:path</span> <span class="token string">"/"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">ring/create-default-handler</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>We’re also including some useful middlewares: <code>redirect-trailing-slash-handler</code> to resolve routes with traling slashes, <code>create-resource-handler</code> to serve static files, and <code>create-default-handler</code> to handle common 40x responses.</p>
<h3 id="implementing-middlewares" tabindex="-1"><a class="header-anchor" href="#implementing-middlewares">Implementing Middlewares</a></h3>
<p>If you remember the <code>:handler/ring</code> from earlier, you’ll notice that it has two dependencies, <code>database</code> and <code>auth</code>. Currently they’re inaccessible from our route handlers. To fix this, we can inject these components into the Ring request map using a middleware.</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/handler.clj</span>
<span class="token comment">;; ...</span>

<span class="token punctuation">(</span><span class="token keyword">defn-</span> components-middleware
  <span class="token punctuation">[</span>components<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>database auth<span class="token punctuation">]</span><span class="token punctuation">}</span> components<span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span>handler<span class="token punctuation">]</span>
      <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span>req<span class="token punctuation">]</span>
        <span class="token punctuation">(</span><span class="token function">handler</span> <span class="token punctuation">(</span><span class="token keyword">assoc</span> req
                        <span class="token symbol">:db</span> database
                        <span class="token symbol">:auth</span> auth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; ...</span></code></pre>
<p>The <code>components-middleware</code> function takes in a map of components and creates a middleware function that assocs each component into the request map. If you have more components such as a [Redis] cache or a mail service, you can add them here.</p>
<p>We’ll also need a middleware to handle HTTP basic authentication.<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup> This middleware will check if the username and password from the request map matches the values in the <code>auth</code> map injected by <code>components-middleware</code>. If they match, then the request is authenticated and the user can view the site.</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/handler.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.handler
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token comment">;; ...</span>
   <span class="token punctuation">[</span>acme.util <span class="token symbol">:as</span> util<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>ring.util.response <span class="token symbol">:as</span> res<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; ...</span>

<span class="token punctuation">(</span><span class="token keyword">defn-</span> wrap-basic-auth
  <span class="token punctuation">[</span>handler<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span>req<span class="token punctuation">]</span>
    <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>headers auth<span class="token punctuation">]</span><span class="token punctuation">}</span> req
          <span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>username password<span class="token punctuation">]</span><span class="token punctuation">}</span> auth
          authorization <span class="token punctuation">(</span><span class="token keyword">get</span> headers <span class="token string">"authorization"</span><span class="token punctuation">)</span>
          correct-creds <span class="token punctuation">(</span><span class="token keyword">str</span> <span class="token string">"Basic "</span> <span class="token punctuation">(</span><span class="token function">util/base64-encode</span>
                                       <span class="token punctuation">(</span><span class="token function">format</span> <span class="token string">"%s:%s"</span> username password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">and</span> authorization <span class="token punctuation">(</span><span class="token keyword">=</span> correct-creds authorization<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token function">handler</span> req<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">-></span> <span class="token punctuation">(</span><span class="token function">res/response</span> <span class="token string">"Access Denied"</span><span class="token punctuation">)</span>
            <span class="token punctuation">(</span><span class="token function">res/status</span> <span class="token number">401</span><span class="token punctuation">)</span>
            <span class="token punctuation">(</span><span class="token function">res/header</span> <span class="token string">"WWW-Authenticate"</span> <span class="token string">"Basic realm=protected"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; ...</span></code></pre>
<p>A nice feature of Clojure is that interop with the host language is easy. The <code>base64-encode</code> function is a thin wrapper over Java’s <code>Base64.Encoder</code>:</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/util.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.util
   <span class="token comment">;; ...</span>
  <span class="token punctuation">(</span><span class="token symbol">:import</span> java.util.Base64<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> base64-encode
  <span class="token punctuation">[</span>s<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">.encodeToString</span> <span class="token punctuation">(</span><span class="token function">Base64/getEncoder</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">.getBytes</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>Finally, we need to add them to the router. Since we’ll be handling form requests later, we’ll also bring in Ring’s <code>wrap-params</code> middleware.</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/handler.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.handler
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token comment">;; ...</span>
   <span class="token punctuation">[</span>ring.middleware.params <span class="token symbol">:refer</span> <span class="token punctuation">[</span>wrap-params<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; ...</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> handler
  <span class="token punctuation">[</span>opts<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token function">ring/ring-handler</span>
   <span class="token comment">;; ...</span>
   <span class="token punctuation">{</span><span class="token symbol">:middleware</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token function">components-middleware</span> opts<span class="token punctuation">)</span>
                 wrap-basic-auth
                 wrap-params<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h3 id="implementing-route-handlers" tabindex="-1"><a class="header-anchor" href="#implementing-route-handlers">Implementing Route Handlers</a></h3>
<p>We now have everything we need to implement the route handlers or the business logic of the app. First, we’ll implement the <code>index-page</code> function which renders a page that:</p>
<ol>
<li>Shows all of the user’s bookmarks in the database</li>
<li>Shows a form that allows the user to insert new bookmarks into the database</li>
</ol>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/handler.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.handler
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token comment">;; ...</span>
   <span class="token punctuation">[</span>next.jdbc <span class="token symbol">:as</span> jdbc<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>next.jdbc.sql <span class="token symbol">:as</span> sql<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; ...</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> template
  <span class="token punctuation">[</span>bookmarks<span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token symbol">:html</span>
   <span class="token punctuation">[</span><span class="token symbol">:head</span>
    <span class="token punctuation">[</span><span class="token symbol">:meta</span> <span class="token punctuation">{</span><span class="token symbol">:charset</span> <span class="token string">"utf-8"</span>
            <span class="token symbol">:name</span>    <span class="token string">"viewport"</span>
            <span class="token symbol">:content</span> <span class="token string">"width=device-width, initial-scale=1.0"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
   <span class="token punctuation">[</span><span class="token symbol">:body</span>
    <span class="token punctuation">[</span><span class="token symbol">:h1</span> <span class="token string">"bookmarks"</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token symbol">:form</span> <span class="token punctuation">{</span><span class="token symbol">:method</span> <span class="token string">"POST"</span><span class="token punctuation">}</span>
     <span class="token punctuation">[</span><span class="token symbol">:div</span>
      <span class="token punctuation">[</span><span class="token symbol">:label</span> <span class="token punctuation">{</span><span class="token symbol">:for</span> <span class="token string">"url"</span><span class="token punctuation">}</span> <span class="token string">"url "</span><span class="token punctuation">]</span>
      <span class="token punctuation">[</span><span class="token symbol">:input</span><span class="token operator">#</span>url <span class="token punctuation">{</span><span class="token symbol">:name</span> <span class="token string">"url"</span>
                   <span class="token symbol">:type</span> <span class="token string">"url"</span>
                   <span class="token symbol">:required</span> <span class="token boolean">true</span>
                   <span class="token symbol">:placeholer</span> <span class="token string">"https://en.wikipedia.org/"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
     <span class="token punctuation">[</span><span class="token symbol">:button</span> <span class="token string">"submit"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token symbol">:p</span> <span class="token string">"your bookmarks:"</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token symbol">:ul</span>
     <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">empty?</span> bookmarks<span class="token punctuation">)</span>
       <span class="token punctuation">[</span><span class="token symbol">:li</span> <span class="token string">"you don't have any bookmarks"</span><span class="token punctuation">]</span>
       <span class="token punctuation">(</span><span class="token keyword">map</span>
        <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
          <span class="token punctuation">[</span><span class="token symbol">:li</span>
           <span class="token punctuation">[</span><span class="token symbol">:a</span> <span class="token punctuation">{</span><span class="token symbol">:href</span> url<span class="token punctuation">}</span> url<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        bookmarks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> index-page
  <span class="token punctuation">[</span>req<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">try</span>
    <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>bookmarks <span class="token punctuation">(</span><span class="token function">sql/query</span> <span class="token punctuation">(</span><span class="token symbol">:db</span> req<span class="token punctuation">)</span>
                               <span class="token punctuation">[</span><span class="token string">"select * from bookmarks"</span><span class="token punctuation">]</span>
                               jdbc/unqualified-snake-kebab-opts<span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">(</span><span class="token function">util/render</span> <span class="token punctuation">(</span><span class="token function">template</span> bookmarks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">catch</span> Exception e
      <span class="token punctuation">(</span><span class="token function">util/server-error</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; ...</span></code></pre>
<p>Database queries can sometimes throw exceptions, so it’s good to wrap them in a try-catch block. I’ll also introduce some helper functions:</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/util.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.util
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token comment">;; ...</span>
   <span class="token punctuation">[</span>hiccup2.core <span class="token symbol">:as</span> h<span class="token punctuation">]</span>
   <span class="token punctuation">[</span>ring.util.response <span class="token symbol">:as</span> res<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token symbol">:import</span> java.util.Base64<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; ...</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> preprend-doctype
  <span class="token punctuation">[</span>s<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">str</span> <span class="token string">"&lt;!doctype html>"</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> render
  <span class="token punctuation">[</span>hiccup<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">-></span> hiccup h/html str preprend-doctype res/response <span class="token punctuation">(</span><span class="token function">res/content-type</span> <span class="token string">"text/html"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> server-error
  <span class="token punctuation">[</span>e<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">"Caught exception: "</span> e<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">-></span> <span class="token punctuation">(</span><span class="token function">res/response</span> <span class="token string">"Internal server error"</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token function">res/status</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p><code>render</code> takes a hiccup form and turns it into a ring response, while <code>server-error</code> takes an exception, logs it, an returns a 500 response.</p>
<p>Next, we’ll implement the <code>index-action</code> function:</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/handler.clj</span>
<span class="token comment">;; ...</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> index-action
  <span class="token punctuation">[</span>req<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">try</span>
    <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token symbol">:keys</span> <span class="token punctuation">[</span>db form-params<span class="token punctuation">]</span><span class="token punctuation">}</span> req
          value <span class="token punctuation">(</span><span class="token keyword">get</span> form-params <span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">(</span><span class="token function">sql/insert!</span> db <span class="token symbol">:bookmarks</span> <span class="token punctuation">{</span><span class="token symbol">:bookmark_id</span> <span class="token punctuation">(</span><span class="token function">random-uuid</span><span class="token punctuation">)</span> <span class="token symbol">:url</span> value<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token function">res/redirect</span> <span class="token string">"/"</span> <span class="token number">303</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">catch</span> Exception e
      <span class="token punctuation">(</span><span class="token function">util/server-error</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; ...</span></code></pre>
<p>This is an implementation of a typical <a href="https://en.wikipedia.org/wiki/Post/Redirect/Get">post/redirect/get</a> pattern. We get the value from the <code>&quot;url&quot;</code> form field, insert a new row in the database with that value, and redirect back to the index page. Again, we’re using a try-catch block to handle possible exceptions from the database query.</p>
<p>That should be all of the code for the controllers. If you reload your REPL and go to <code>http://localhost:8080</code>, you should see something that looks like this after logging in:</p>
<p>![[clojure-fly-1.png]]</p>
<p>The last thing we need to do is to update the main function to start the system:</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/main.clj</span>
<span class="token comment">;; ...</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> -main <span class="token punctuation">[</span>&amp; _<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">-></span> <span class="token punctuation">(</span><span class="token function">read-config</span><span class="token punctuation">)</span> ig/expand ig/init<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>Now, you should be able to run the app using <code>clj -M -m acme.main</code>. That should be all the code needed for the application. Reload your REPL and try out the app in http://localhost:8080! In the next section, we’ll package the app into a docker image to deploy to Fly.</p>
<h2 id="packaging-the-application" tabindex="-1"><a class="header-anchor" href="#packaging-the-application">Packaging the Application</a></h2>
<p>While there are <a href="https://www.metosin.fi/blog/packaging-clojure">many approaches to packaging a clojure application</a>, Fly.io specifically requires a docker image to deploy an app. There are two approaches to doing this:</p>
<ol>
<li>Build an uberjar and run it using Java in the container, or</li>
<li>Load the source code and run it directly using Clojure in the container</li>
</ol>
<p>Both are valid approaches. I prefer the first approach since its only dependency is the JVM. We’ll use the <a href="https://github.com/clojure/tools.build">tools.build</a> library to build the uberjar. Checkout the <a href="https://clojure.org/guides/tools_build">official guide</a> for more information on building Clojure programs. Since it’s a library, to use it we can add it to our <code>deps.edn</code> file with an alias:</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; deps.edn</span>
<span class="token punctuation">{</span><span class="token comment">;; ...</span>
 <span class="token symbol">:aliases</span>
 <span class="token punctuation">{</span><span class="token comment">;; ...</span>
  <span class="token symbol">:build</span> <span class="token punctuation">{</span><span class="token symbol">:extra-deps</span> <span class="token punctuation">{</span>io.github.clojure/tools.build 
                       <span class="token punctuation">{</span><span class="token symbol">:git/tag</span> <span class="token string">"v0.10.5"</span> <span class="token symbol">:git/sha</span> <span class="token string">"2a21b7a"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token symbol">:ns-default</span> build<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>
<p>Tools.build expects a <code>build.clj</code> file in the root of the project directory, so we’ll need to create that file. This file contains the instructions to build artefacts, which in our case is a single uberjar. There are many great examples of <code>build.clj</code> files on the web, including from the official docs. For now, you can copy+paste this file into your project.</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; build.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> build
  <span class="token punctuation">(</span><span class="token symbol">:require</span>
   <span class="token punctuation">[</span>clojure.tools.build.api <span class="token symbol">:as</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">def</span> basis <span class="token punctuation">(</span><span class="token function">delay</span> <span class="token punctuation">(</span><span class="token function">b/create-basis</span> <span class="token punctuation">{</span><span class="token symbol">:project</span> <span class="token string">"deps.edn"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">def</span> src-dirs <span class="token punctuation">[</span><span class="token string">"src"</span> <span class="token string">"resources"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">def</span> class-dir <span class="token string">"target/classes"</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">defn</span> uber
  <span class="token punctuation">[</span>_<span class="token punctuation">]</span>
  <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">"Cleaning build directory..."</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">b/delete</span> <span class="token punctuation">{</span><span class="token symbol">:path</span> <span class="token string">"target"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">"Copying files..."</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">b/copy-dir</span> <span class="token punctuation">{</span><span class="token symbol">:src-dirs</span>   src-dirs
               <span class="token symbol">:target-dir</span> class-dir<span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">"Compiling Clojure..."</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">b/compile-clj</span> <span class="token punctuation">{</span><span class="token symbol">:basis</span>      <span class="token operator">@</span>basis
                  <span class="token symbol">:ns-compile</span> '<span class="token punctuation">[</span>acme.main<span class="token punctuation">]</span>
                  <span class="token symbol">:class-dir</span>  class-dir<span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">(</span><span class="token keyword">println</span> <span class="token string">"Building Uberjar..."</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">b/uber</span> <span class="token punctuation">{</span><span class="token symbol">:basis</span>     <span class="token operator">@</span>basis
           <span class="token symbol">:class-dir</span> class-dir
           <span class="token symbol">:uber-file</span> <span class="token string">"target/standalone.jar"</span>
           <span class="token symbol">:main</span>      'acme.main<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>To build the project, run <code>clj -T:build uber</code>. This will create the uberjar <code>standalone.jar</code> in the <code>target</code> directory. The “<code>uber</code>” in “<code>clj -T:build uber</code>” refers to the <code>uber</code> function from <code>build.clj</code>. Since the build system is a Clojure program, you can customise it however you like. If we try to run it using <code>java -jar target/standalone.jar</code>, we’ll get this error:</p>
<pre class="language-bash"><code class="language-bash"><code style="user-select:none;color:var(--color-links)">$ </code><span class="token function">java</span> <span class="token parameter variable">-jar</span> target/standalone.jar
Error: Could not <span class="token function">find</span> or load main class acme.main
Caused by: java.lang.ClassNotFoundException: acme.main</code></pre>
<p>This error occurred because the Main class that is required by Java isn’t built. To fix this, we need to add the <code>:gen-class</code> directive in our main namespace. This will instruct Clojure to create the Main class from the <code>-main</code> function.</p>
<pre class="language-clojure"><code class="language-clojure"><span class="token comment">;; src/acme/main.clj</span>
<span class="token punctuation">(</span><span class="token keyword">ns</span> acme.main
  <span class="token comment">;; ...</span>
  <span class="token punctuation">(</span><span class="token symbol">:gen-class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; ...</span></code></pre>
<p>if you rebuild the project and run <code>java -jar target/standalone.jar</code> again, it should work perfectly. Now that we have a working build script, we can write the Dockerfile:</p>
<pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># Dockerfile</span>
<span class="token comment"># install additional dependencies here in the base layer</span>
<span class="token comment"># separate base from build layer so any additional deps installed are cached</span>
<span class="token instruction"><span class="token keyword">FROM</span> clojure:temurin-21-tools-deps-bookworm-slim <span class="token keyword">AS</span> base</span>

<span class="token instruction"><span class="token keyword">FROM</span> base <span class="token keyword">as</span> build</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /opt</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">RUN</span> clj -T:build uber</span>

<span class="token instruction"><span class="token keyword">FROM</span> eclipse-temurin:21-alpine <span class="token keyword">AS</span> prod</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /opt/target/standalone.jar /</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 8080</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">"java"</span>, <span class="token string">"-jar"</span>, <span class="token string">"standalone.jar"</span>]</span></code></pre>
<p>It’s a <a href="https://www.docker.com/blog/multi-stage-builds/">multi-stage Dockerfile</a>. We use the official clojure docker image as the layer to build the uberjar. Once it’s built, we copy it to a smaller docker image that only contains the Java runtime.<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup> By doing this, we get a smaller container image as well as a faster docker build time because the layers are better cached.<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup></p>
<p>That should be all for packaging the app. We can move on to the deployment now.</p>
<h2 id="deploying-with-fly.io" tabindex="-1"><a class="header-anchor" href="#deploying-with-fly.io">Deploying with Fly.io</a></h2>
<p>First things first, you’ll need to <a href="https://fly.io/docs/flyctl/install/">install <code>flyctl</code></a>, Fly’s CLI tool for interacting with their platform. Create <a href="https://fly.io/app/sign-up">a Fly.io account</a> if you haven’t already. Then run <code>fly auth login</code> to authenticate <code>flyctl</code> with your account.</p>
<p>Next, we’ll need to create a new <a href="https://fly.io/docs/apps/overview/">Fly App</a>:</p>
<pre class="language-bash"><code class="language-bash"><code style="user-select:none;color:var(--color-links)">$ </code>fly app create
? Choose an app name <span class="token punctuation">(</span>leave blank to generate one<span class="token punctuation">)</span>: 
automatically selected personal organization: Ryan Martin
New app created: blue-water-6489</code></pre>
<p>Another way to do this is with the <code>fly launch</code> command, which automates a lot of the app configuration for you. We have some steps to do that’s not done by <code>fly launch</code>, so we’ll be configuring the app manually. I also already have a <code>fly.toml</code> file ready that you can straight away copy to your project.</p>
<pre class="language-toml"><code class="language-toml"><span class="token comment"># fly.toml</span>
<span class="token comment"># replace these with your app and region name</span>
<span class="token key property">app</span> <span class="token punctuation">=</span> <span class="token string">'blue-water-6489'</span> 
<span class="token key property">primary_region</span> <span class="token punctuation">=</span> <span class="token string">'sin'</span>

<span class="token punctuation">[</span><span class="token table class-name">env</span><span class="token punctuation">]</span>
  <span class="token key property">DB_DATABASE</span> <span class="token punctuation">=</span> <span class="token string">"/data/database.db"</span>

<span class="token punctuation">[</span><span class="token table class-name">http_service</span><span class="token punctuation">]</span>
  <span class="token key property">internal_port</span> <span class="token punctuation">=</span> <span class="token number">8080</span>
  <span class="token key property">force_https</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token key property">auto_stop_machines</span> <span class="token punctuation">=</span> <span class="token string">"stop"</span>
  <span class="token key property">auto_start_machines</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token key property">min_machines_running</span> <span class="token punctuation">=</span> <span class="token number">0</span>

<span class="token punctuation">[</span><span class="token table class-name">mounts</span><span class="token punctuation">]</span>
  <span class="token key property">source</span> <span class="token punctuation">=</span> <span class="token string">"data"</span>
  <span class="token key property">destination</span> <span class="token punctuation">=</span> <span class="token string">"/data"</span>
  <span class="token key property">initial_sie</span> <span class="token punctuation">=</span> <span class="token number">1</span>

<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token table class-name">vm</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token key property">size</span> <span class="token punctuation">=</span> <span class="token string">"shared-cpu-1x"</span>
  <span class="token key property">memory</span> <span class="token punctuation">=</span> <span class="token string">"512mb"</span>
  <span class="token key property">cpus</span> <span class="token punctuation">=</span> <span class="token number">1</span>
  <span class="token key property">cpu_kind</span> <span class="token punctuation">=</span> <span class="token string">"shared"</span></code></pre>
<p>These are mostly the default config values with some additions. Under the <code>[env]</code> section, we’re setting the SQLite database location to <code>/data/database.db</code>. The <code>database.db</code> file itself will be stored in a persistent <a href="https://fly.io/docs/volumes/overview/">Fly Volume</a> mounted on the <code>/data</code> directory. This is specified under the <code>[mounts]</code> section. Fly Volumes are similar to regular docker volumes, but are designed for Fly’s micro VMs.</p>
<p>We’ll need to set the <code>AUTH_USER</code> and <code>AUTH_PASSWORD</code> environment variables too, but not through the <code>fly.toml</code> file as these are sensitive values. To securely set these credentials with Fly, we can set them as <a href="https://fly.io/docs/apps/secrets/">app secrets</a>. They’re stored encrypted and will be automatically injected to the app at boot time.</p>
<pre class="language-bash"><code class="language-bash"><code style="user-select:none;color:var(--color-links)">$ </code>fly secrets <span class="token builtin class-name">set</span> <span class="token assign-left variable">AUTH_USER</span><span class="token operator">=</span>hi@ryanmartin.me <span class="token assign-left variable">AUTH_PASSWORD</span><span class="token operator">=</span>not-so-secure-password
Secrets are staged <span class="token keyword">for</span> the first deployment</code></pre>
<p>With this, configuration is done and we can deploy the app using <code>fly deploy</code></p>
<pre class="language-bash"><code class="language-bash"><code style="user-select:none;color:var(--color-links)">$ </code>fly deploy
<span class="token comment"># ...</span>

Visit your newly deployed app at https://blue-water-6489.fly.dev/</code></pre>
<p>The first deployment will take longer since it’s building the docker image for the first time. Subsequent deployments should be faster due to the cached image layers. You can click on the link to view the deployed app, or you can also run <code>fly open</code> which will do the same thing. Here’s the app in action:</p>
<p>![[clojure-fly-2.webp]]</p>
<p>If you made additional changes to the app or <code>fly.toml</code>, you can redeploy the app using the same command, <code>fly deploy</code>. The app is configured to auto stop/start, which helps to cut costs when there’s not a lot of traffic to the site. If you want to take down the deployment, you’ll need to delete the app itself using <code>fly app destroy &lt;your app name&gt;</code>.</p>
<h2 id="adding-a-production-repl" tabindex="-1"><a class="header-anchor" href="#adding-a-production-repl">Adding a Production REPL</a></h2>
<p>This is an interesting topic in the Clojure community, with varying opinions on whether or not it’s a good idea. Personally I find having a REPL connected to the live app helpful, and I often use it for debugging and running queries on the live database.<sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup> Since we’re using SQLite, we don’t have a database server we can directly connect to unlike Postgres or MySQL.</p>
<p>If you’re brave, you can even restart the app directly without redeploying from the REPL. You can easily go wrong with it, which is why some prefer to not use it.</p>
<p>For this project, we’re gonna add a <a href="https://clojure.org/reference/repl_and_main#_launching_a_socket_server">socket REPL</a>. It’s very simple to add (you just need to add a JVM option) and it doesn’t require additional dependencies like <a href="https://nrepl.org/">nREPL</a>. Let’s update the Dockerfile:</p>
<pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># Dockerfile</span>
<span class="token comment"># ...</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 7888</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">"java"</span>, <span class="token string">"-Dclojure.server.repl={:port 7888 :accept clojure.core.server/repl}"</span>, <span class="token string">"-jar"</span>, <span class="token string">"standalone.jar"</span>]</span></code></pre>
<p>The socket REPL will be listening on port 7888. If we redeploy the app now, the REPL will be started but we won’t be able to connect to it. That’s because we haven’t exposed the service through <a href="https://fly.io/docs/reference/fly-proxy/">Fly proxy</a>. We can do this by adding the socket REPL as a service in the <code>[services]</code> section in <code>fly.toml</code>.</p>
<p>However, doing this will also expose the REPL port to the public. This means that anyone can connect to your REPL and wreck your app. Instead, what we want to do is to configure the socket REPL as a private service.</p>
<p>By default, all Fly apps in your organisation live in the same <a href="https://fly.io/docs/networking/private-networking/">private network</a>. This private network, called 6PN, connects the apps in your organisation through <a href="https://www.wireguard.com/">Wireguard tunnels</a> (a VPN) using IPv6. Fly private services aren’t exposed to the public internet but can be reached from this private network. We can then use Wireguard to connect to this private network to reach our socket REPL.</p>
<p>Fly VMs are also configured with the hostname <code>fly-local-6pn</code>, which maps to its own 6PN address. This is analogous to <code>localhost</code>, which points to your loopback address<code>127.0.0.1</code>. To expose a service to 6PN, all we have to do is bind or serve it to <code>fly-local-6pn</code> instead of the usual <code>0.0.0.0</code>. We have to update the socket REPL options to:</p>
<pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># Dockerfile</span>
<span class="token comment"># ...</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">"java"</span>, <span class="token string">"-Dclojure.server.repl={:port 7888,:address \"fly-local-6pn\",:accept clojure.core.server/repl}"</span>, <span class="token string">"-jar"</span>, <span class="token string">"standalone.jar"</span>]</span></code></pre>
<p>After redeploying, we can use the <code>fly proxy</code> command to forward the port from the remote server to our local machine.<sup class="footnote-ref"><a href="#fn9" id="fnref9">[9]</a></sup></p>
<pre class="language-bash"><code class="language-bash"><code style="user-select:none;color:var(--color-links)">$ </code>fly proxy <span class="token number">7888</span>:7888
Proxying <span class="token builtin class-name">local</span> port <span class="token number">7888</span> to remote <span class="token punctuation">[</span>blue-water-6489.internal<span class="token punctuation">]</span>:7888</code></pre>
<p>In another shell, run:</p>
<pre class="language-bash"><code class="language-bash"><code style="user-select:none;color:var(--color-links)">$ </code>rlwrap <span class="token function">nc</span> localhost <span class="token number">7888</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token operator">></span></code></pre>
<p>Now we have a REPL connected to the production app! <code>rlwrap</code> is used for <a href="https://en.wikipedia.org/wiki/GNU_Readline">readline</a> functionality, e.g. up/down arrow keys, vi bindings. Of course you can also connect to it from your editor.</p>
<h2 id="deploy-with-github-actions" tabindex="-1"><a class="header-anchor" href="#deploy-with-github-actions">Deploy with GitHub Actions</a></h2>
<p>If you’re using <a href="https://github.com">GitHub</a>, we can also setup automatic deployments on pushes/PRs with <a href="https://github.com/features/actions">GitHub Actions</a>. All you need is to create the workflow file:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token comment"># .github/workflows/fly.yaml</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> Fly Deploy
<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> main
  <span class="token key atrule">workflow_dispatch</span><span class="token punctuation">:</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy app
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">concurrency</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>group
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> superfly/flyctl<span class="token punctuation">-</span>actions/setup<span class="token punctuation">-</span>flyctl@master
      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> flyctl deploy <span class="token punctuation">-</span><span class="token punctuation">-</span>remote<span class="token punctuation">-</span>only
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">FLY_API_TOKEN</span><span class="token punctuation">:</span> $</code></pre>
<p>To get this to work, you’ll need to create a <a href="https://fly.io/docs/security/tokens/">deploy token</a> from your app’s dashboard. Then, in your GitHub repo, create a new repository secret called <code>FLY_API_TOKEN</code> with the value of your deploy token. Now, whenever you push to the <code>main</code> branch, this workflow will automatically run and deploy your app. You can also manually run the workflow from GitHub because of the <code>workflow_dispatch</code> option.</p>
<h2 id="end" tabindex="-1"><a class="header-anchor" href="#end">End</a></h2>
<p>Overall, I like how easy and fast it is to get a Clojure app deployed to Fly.io. It’s great platform for deploying side projects or hackathon projects. My side projects are never finished so I don’t have any experience yet to share about how well Fly handles real user traffic. Anyways, here are some further reading about deploying Clojure apps:</p>
<ul>
<li><a href="https://bogoyavlensky.com/blog/deploying-full-stack-clojure-app-with-kamal/">Deploying a Full-Stack Clojure App With Kamal on a Single Server</a></li>
<li><a href="https://ericnormand.me/article/jvm-deployment-options">JVM Deployment Options</a></li>
<li><a href="https://tonitalksdev.com/deploying-clojure-like-a-seasoned-hobbyist">Deploying Clojure Like a Seasoned Hobbyist</a></li>
<li><a href="https://www.braveclojure.com/quests/deploy/">Brave Clojure’s Deploy Quest</a></li>
</ul>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>The way Fly.io works under the hood is pretty clever. Instead of running the container image with a runtime like Docker, the image is unpacked and “loaded” into a VM. See <a href="https://www.youtube.com/watch?v=7iypMRKniPU">this video explanation</a> for more details. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>If you’re new to Clojure, I’d suggest you to follow <a href="https://clojure.org/guides/getting_started">the official getting started guide</a> and join the <a href="https://clojurians.slack.com/">Clojurians Slack</a>. Also, read through this <a href="https://gist.github.com/yogthos/be323be0361c589570a6da4ccc85f58f">list of introductory resources</a>. <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>Kit was a big influence on me when I first started learning we development in Clojure. I never used it directly, but I did use their library choices and project structure as a base for my own projects. <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p>There might be some keys that you add or remove, but the structure of the config file stays the same. <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p>For more details on how basic authentication works, checkout <a href="https://www.rfc-editor.org/rfc/rfc7617.html">the specification</a>. <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p>Here’s a cool resource I found when researching about Java Dockerfiles: https://whichjdk.com. It provides a comprehensive comparison on the different JDKs available and recommendations on which one you should use. <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p>If your dependencies don’t change often, the second approach might produce faster builds as you don’t have to reinstall the dependencies again. <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn8" class="footnote-item"><p>Another (non-technically important) argument for live/production REPLs is just because it’s cool. Ever since I read the story about <a href="https://news.ycombinator.com/item?id=31234338">NASA’s programmers debugging a space craft through a live REPL</a>, I’ve always wanted to try it at least once. <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn9" class="footnote-item"><p>If you encounter errors related to Wireguard when running <code>fly proxy</code>, you can run <code>fly doctor</code> which will hopefully detect issues with your local setup and also suggest fixes for them. <a href="#fnref9" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

  <section>
    <h4>Tags:</h4>
    <ul class="tags"><li><a href="/tags/clojure">#clojure</a></li><li><a href="/tags/deployment">#deployment</a></li><li><a href="/tags/java">#java</a></li><li><a href="/tags/networking">#networking</a></li><li><a href="/tags/web-development">#web-development</a></li></ul>
  </section>
</article>

    </main>
    <footer>
      <div>
        <a href="https://github.com/rmrt1n">GitHub</a>
        <a href="https://linkedin.com/in/ryanmrt1n">LinkedIn</a>
        <a href="https://twitter.com/gud_mornign">Twitter</a>
        
        <a href="mailto:hi@ryanmartin.me">hi@ryanmartin.me</a>
      </div>
      <small>CC BY-NC 4.0 2024 &copy; Ryan Martin</small>
    </footer>
  </body>
</html>
